import{_ as Z,o as tt,K as et,c as a,a as t,d as b,b as l,n as f,r as h,t as d,F as S,k as I,x as O,e as g,q as st,A as nt,g as L,B as C,j as lt,f as i,w as ot,y as at}from"./index-BtR8u1Yc.js";import{L as o}from"./localeText-CcPMTEBg.js";const it={class:"peerHealthMonitor"},ct={class:"d-flex align-items-center mb-4"},dt={class:"mb-0"},ut={class:"ms-auto"},rt=["disabled"],_t=["disabled"],bt={key:0,class:"row mb-4"},ht={class:"col-md-3"},mt={class:"card bg-dark"},ft={class:"card-body text-center"},vt={class:"mb-0"},gt={class:"text-muted"},pt={class:"col-md-3"},kt={class:"card bg-dark"},yt={class:"card-body text-center"},xt={class:"mb-0 text-success"},Ct={class:"text-muted"},wt={class:"col-md-3"},St={class:"card bg-dark"},Pt={class:"card-body text-center"},It={class:"mb-0 text-danger"},Nt={class:"text-muted"},Ht={class:"col-md-3"},Et={class:"card bg-dark"},Ot={class:"card-body text-center"},Wt={class:"mb-0 text-info"},$t={class:"text-muted"},Dt={class:"card bg-dark mb-4"},Lt={class:"card-header"},jt={class:"card-body"},At={key:0,class:"row"},Mt={class:"card bg-secondary bg-opacity-25"},Rt={class:"card-body"},Tt={class:"d-flex align-items-center mb-3"},Ut={class:"mb-0"},Bt={class:"form-check form-switch ms-auto"},Vt=["checked","onChange"],Ft={class:"form-check-label"},Kt={class:"row g-2"},zt={class:"col-6"},qt={class:"form-label small"},Gt=["value","onChange"],Jt={class:"col-6"},Qt={class:"form-label small"},Xt=["value","onChange"],Yt={class:"form-check mt-2"},Zt=["checked","onChange"],te={class:"form-check-label small"},ee={key:1,class:"text-muted text-center py-3"},se={class:"card bg-dark"},ne={class:"card-header d-flex align-items-center"},le={class:"badge bg-success ms-2"},oe=["title"],ae={class:"card-body p-0"},ie={class:"table-responsive"},ce={class:"table table-dark table-hover mb-0"},de={key:0,class:"bi bi-arrow-repeat text-warning ms-1",title:"Endpoint recently changed"},ue={class:"small"},re={key:0,class:"text-info"},_e={key:1,class:"text-muted small"},be={key:0},he={key:1,class:"text-muted"},me={key:0,class:"progress",style:{height:"20px",width:"80px"}},fe={key:1,class:"text-muted"},ve={class:"text-muted"},ge={class:"small text-truncate d-inline-block",style:{"max-width":"150px"}},pe=["onClick","disabled"],ke={class:"text-center"},ye=["onClick","title"],xe={key:0},Ce={colspan:"11",class:"text-center text-muted py-4"},we={class:"mt-3 small text-muted"},Se={key:0,class:"badge bg-danger me-2 ms-3"},Pe={key:1},Ie={key:1,class:"text-muted small mt-3 text-end"},Ne={key:0,class:"modal d-block",tabindex:"-1",style:{"background-color":"rgba(0,0,0,0.5)"}},He={class:"modal-dialog"},Ee={class:"modal-content bg-dark"},Oe={class:"modal-header"},We={class:"modal-title"},$e={class:"modal-body"},De={class:"mb-3"},Le={class:"form-label"},je={class:"text-muted"},Ae={class:"mb-3 d-flex align-items-center gap-2"},Me={class:"text-muted text-nowrap"},Re={class:"d-flex flex-wrap gap-3"},Te=["id","checked","onChange"],Ue=["for"],Be={key:0,class:"mb-3"},Ve={class:"form-label"},Fe=["id","checked","onChange"],Ke=["for"],ze={key:0,class:"badge bg-warning ms-1"},qe={key:1,class:"text-muted small"},Ge={class:"modal-footer"},Je={__name:"peerHealthMonitor",setup(Qe){const c=h({running:!1,peers:{},interfaces:{},stats:{}}),m=h(!1),p=h(!1);let N=null;const W=O(()=>{const n={online:0,unpingable:1,recent:2,offline:3,unknown:4};let e=Object.entries(c.value.peers||{});return p.value||(e=e.filter(([r,s])=>s.status!=="offline"&&s.status!=="unknown")),e.sort((r,s)=>{const u=n[r[1].status]??5,_=n[s[1].status]??5;return u-_}),Object.fromEntries(e)}),$=O(()=>Object.entries(c.value.peers||{}).filter(([e,r])=>r.status==="offline"||r.status==="unknown").length),j=O(()=>Object.keys(W.value).length);function v(){L("/api/health/status",{},n=>{n&&n.status&&(c.value=n.data)})}function A(){m.value=!0;const n=c.value.running?"/api/health/stop":"/api/health/start";C(n,{},()=>{v(),m.value=!1})}function M(){m.value=!0,C("/api/health/cycle",{},()=>{v(),m.value=!1})}function R(n){m.value=!0,C(`/api/health/peer/${encodeURIComponent(n)}/ping`,{},()=>{v(),m.value=!1})}const y=h(!1),H=h(""),D=h(""),w=h(""),k=h([]),E=h([]),x=h([]),T=[{id:"peer_went_online",label:"Went Online"},{id:"peer_went_offline",label:"Went Offline"},{id:"peer_endpoint_changed",label:"Endpoint Changed"}];function U(n,e){H.value=n,D.value=e.name||n.substring(0,8)+"...",w.value=(e.notify_emails||[]).join(", "),k.value=[...e.notify_webhooks||[]],x.value=[...e.notify_events||["peer_went_online","peer_went_offline","peer_endpoint_changed"]],L("/api/webHooks/getWebHooks",{},r=>{E.value=r.data||[]}),y.value=!0}function B(){const n=w.value.split(",").map(e=>e.trim()).filter(e=>e.length>0);C(`/api/health/peer/${encodeURIComponent(H.value)}/notify`,{emails:n,webhooks:k.value,events:x.value},()=>{v(),y.value=!1})}function V(){C(`/api/health/peer/${encodeURIComponent(H.value)}/notify`,{emails:[],webhooks:[]},()=>{v(),y.value=!1})}function F(n){const e=k.value.indexOf(n);e>=0?k.value.splice(e,1):k.value.push(n)}function K(n){const e=x.value.indexOf(n);e>=0?x.value.splice(e,1):x.value.push(n)}function z(n,e){P(n,"enabled",e)}function P(n,e,r){C(`/api/health/config/${n}`,{[e]:r},()=>{v()})}function q(n){return{online:"bg-success",unpingable:"bg-info text-dark",recent:"bg-warning text-dark",offline:"bg-danger",unknown:"bg-secondary"}[n]||"bg-secondary"}function G(n){return{online:"online",unpingable:"unpingable",recent:"recent",offline:"offline",unknown:"unknown"}[n]||n}function J(n){return n.status==="offline"||n.status==="unknown"?"bi-dash text-muted":n.status==="unpingable"?"bi-shield-x text-info":n.is_pingable?"bi-check-circle text-success":"bi-x-circle text-danger"}function Q(n){return n>=80?"bg-success":n>=50?"bg-warning":"bg-danger"}function X(n){return n?new Date(n).toLocaleTimeString():"-"}function Y(n){return n?new Date(n).toLocaleString():"-"}return tt(()=>{v(),N=setInterval(v,1e4)}),et(()=>{N&&clearInterval(N)}),(n,e)=>{const r=lt("router-link");return i(),a(S,null,[t("div",it,[t("div",ct,[t("h5",dt,[e[4]||(e[4]=t("i",{class:"bi bi-heart-pulse me-2"},null,-1)),l(o,{t:"Peer Health Monitor"})]),t("span",{class:f(["badge ms-2",c.value.running?"bg-success":"bg-secondary"])},[l(o,{t:c.value.running?"Running":"Stopped"},null,8,["t"])],2),t("div",ut,[t("button",{class:f(["btn btn-sm me-2",c.value.running?"btn-outline-danger":"btn-outline-success"]),onClick:A,disabled:m.value},[t("i",{class:f(["bi",c.value.running?"bi-stop-fill":"bi-play-fill"])},null,2),l(o,{t:c.value.running?"Stop":"Start"},null,8,["t"])],10,rt),t("button",{class:"btn btn-sm btn-outline-primary",onClick:M,disabled:m.value||!c.value.running},[e[5]||(e[5]=t("i",{class:"bi bi-arrow-clockwise"},null,-1)),l(o,{t:"Force Check"})],8,_t)])]),c.value.stats?(i(),a("div",bt,[t("div",ht,[t("div",mt,[t("div",ft,[t("h3",vt,d(c.value.stats.total_pings||0),1),t("small",gt,[l(o,{t:"Total Pings"})])])])]),t("div",pt,[t("div",kt,[t("div",yt,[t("h3",xt,d(c.value.stats.successful_pings||0),1),t("small",Ct,[l(o,{t:"Successful"})])])])]),t("div",wt,[t("div",St,[t("div",Pt,[t("h3",It,d(c.value.stats.failed_pings||0),1),t("small",Nt,[l(o,{t:"Failed"})])])])]),t("div",Ht,[t("div",Et,[t("div",Ot,[t("h3",Wt,d(c.value.stats.endpoint_updates||0),1),t("small",$t,[l(o,{t:"Endpoint Updates"})])])])])])):b("",!0),t("div",Dt,[t("div",Lt,[e[6]||(e[6]=t("i",{class:"bi bi-gear me-2"},null,-1)),l(o,{t:"Interface Configuration"})]),t("div",jt,[Object.keys(c.value.interfaces||{}).length>0?(i(),a("div",At,[(i(!0),a(S,null,I(c.value.interfaces,(s,u)=>(i(),a("div",{class:"col-md-6 mb-3",key:u},[t("div",Mt,[t("div",Rt,[t("div",Tt,[t("h6",Ut,d(u),1),t("div",Bt,[t("input",{class:"form-check-input",type:"checkbox",checked:s.enabled,onChange:_=>z(u,_.target.checked)},null,40,Vt),t("label",Ft,[l(o,{t:s.enabled?"Enabled":"Disabled"},null,8,["t"])])])]),t("div",Kt,[t("div",zt,[t("label",qt,[l(o,{t:"Ping Interval (sec)"})]),t("input",{type:"number",class:"form-control form-control-sm",value:s.ping_interval,onChange:_=>P(u,"ping_interval",_.target.value),min:"10",max:"300"},null,40,Gt)]),t("div",Jt,[t("label",Qt,[l(o,{t:"Keepalive (sec)"})]),t("input",{type:"number",class:"form-control form-control-sm",value:s.keepalive_value,onChange:_=>P(u,"keepalive_value",_.target.value),min:"10",max:"120"},null,40,Xt)])]),t("div",Yt,[t("input",{class:"form-check-input",type:"checkbox",checked:s.set_keepalive,onChange:_=>P(u,"set_keepalive",_.target.checked)},null,40,Zt),t("label",te,[l(o,{t:"Auto-set PersistentKeepalive on server"})])])])])]))),128))])):(i(),a("div",ee,[l(o,{t:"No interfaces configured. Start monitoring to detect interfaces."})]))])]),t("div",se,[t("div",ne,[e[7]||(e[7]=t("i",{class:"bi bi-people me-2"},null,-1)),l(o,{t:"Peers Health Status"}),t("span",le,d(j.value)+" active ",1),$.value>0?(i(),a("span",{key:0,class:"badge bg-secondary ms-2",style:{cursor:"pointer"},onClick:e[0]||(e[0]=s=>p.value=!p.value),title:p.value?"Click to hide offline peers":"Click to show offline peers"},[t("i",{class:f(["bi",p.value?"bi-eye-slash":"bi-eye"])},null,2),g(" "+d($.value)+" offline ",1)],8,oe)):b("",!0)]),t("div",ae,[t("div",ie,[t("table",ce,[t("thead",null,[t("tr",null,[t("th",null,[l(o,{t:"Status"})]),t("th",null,[l(o,{t:"Interface"})]),t("th",null,[l(o,{t:"Name"})]),t("th",null,[l(o,{t:"VPN IP"})]),t("th",null,[l(o,{t:"Pingable"})]),e[8]||(e[8]=t("th",null,"RTT",-1)),t("th",null,[l(o,{t:"Success Rate"})]),t("th",null,[l(o,{t:"Last Ping"})]),t("th",null,[l(o,{t:"Endpoint"})]),t("th",null,[l(o,{t:"Actions"})]),t("th",null,[l(o,{t:"Notify"})])])]),t("tbody",null,[(i(!0),a(S,null,I(W.value,(s,u)=>(i(),a("tr",{key:u},[t("td",null,[t("span",{class:f(["badge",q(s.status)])},d(G(s.status)),3),s.endpoint_changed?(i(),a("i",de)):b("",!0)]),t("td",null,[t("code",ue,d(s.interface),1)]),t("td",null,[l(r,{to:`/configuration/${s.interface}/peers?id=${u}&from=health`,class:"text-decoration-none"},{default:ot(()=>[s.name?(i(),a("span",re,d(s.name),1)):(i(),a("span",_e,d(u.substring(0,8))+"...",1))]),_:2},1032,["to"])]),t("td",null,[t("code",null,d(s.vpn_ip),1)]),t("td",null,[t("i",{class:f(["bi",J(s)])},null,2)]),t("td",null,[s.last_ping_success?(i(),a("span",be,d(s.ping_rtt_ms)+" ms ",1)):(i(),a("span",he,"-"))]),t("td",null,[s.status!=="offline"&&s.status!=="unknown"?(i(),a("div",me,[t("div",{class:f(["progress-bar",Q(s.ping_success_rate)]),style:at({width:s.ping_success_rate+"%"})},d(s.ping_success_rate)+"% ",7)])):(i(),a("span",fe,"-"))]),t("td",null,[t("small",ve,d(X(s.last_ping_time)),1)]),t("td",null,[t("code",ge,d(s.last_endpoint||"-"),1)]),t("td",null,[t("button",{class:"btn btn-sm btn-outline-primary",onClick:_=>R(u),disabled:m.value||s.status==="offline",title:"Ping now"},[...e[9]||(e[9]=[t("i",{class:"bi bi-broadcast"},null,-1)])],8,pe)]),t("td",ke,[t("button",{class:f(["btn btn-sm",s.notify?"btn-outline-success":"btn-outline-secondary"]),onClick:_=>U(u,s),title:s.notify?"Notifications configured":"Configure notifications"},[t("i",{class:f(["bi",s.notify?"bi-bell-fill":"bi-bell"])},null,2)],10,ye)])]))),128)),Object.keys(c.value.peers||{}).length===0?(i(),a("tr",xe,[t("td",Ce,[l(o,{t:c.value.running?"Waiting for first check cycle...":"No peer health data available. Start monitoring to collect data."},null,8,["t"])])])):b("",!0)])])])])]),t("div",we,[e[10]||(e[10]=t("span",{class:"badge bg-success me-2"},"online",-1)),e[11]||(e[11]=g(" Connected, ping OK ",-1)),e[12]||(e[12]=t("span",{class:"badge bg-info text-dark me-2 ms-3"},"unpingable",-1)),e[13]||(e[13]=g(" Connected, firewall blocks ping ",-1)),e[14]||(e[14]=t("span",{class:"badge bg-warning text-dark me-2 ms-3"},"recent",-1)),e[15]||(e[15]=g(" Handshake 3-15 min ago ",-1)),p.value?(i(),a("span",Se,"offline")):b("",!0),p.value?(i(),a("span",Pe," Not connected (not pinged)")):b("",!0)]),c.value.stats?.last_cycle_time?(i(),a("div",Ie,[l(o,{t:"Last check"}),g(": "+d(Y(c.value.stats.last_cycle_time))+" ("+d(c.value.stats.last_cycle_duration_ms)+" ms) ",1)])):b("",!0)]),y.value?(i(),a("div",Ne,[t("div",He,[t("div",Ee,[t("div",Oe,[t("h5",We,[e[16]||(e[16]=t("i",{class:"bi bi-bell me-2"},null,-1)),l(o,{t:"Notification Settings"}),g(": "+d(D.value),1)]),t("button",{type:"button",class:"btn-close btn-close-white",onClick:e[1]||(e[1]=s=>y.value=!1)})]),t("div",$e,[t("div",De,[t("label",Le,[l(o,{t:"Email Addresses"})]),st(t("input",{type:"text",class:"form-control bg-secondary bg-opacity-25 text-white","onUpdate:modelValue":e[2]||(e[2]=s=>w.value=s),placeholder:"admin@example.com, tech@example.com"},null,512),[[nt,w.value]]),t("small",je,[l(o,{t:"Comma separated email addresses"})])]),t("div",Ae,[t("small",Me,[l(o,{t:"Events"}),e[17]||(e[17]=g(":",-1))]),t("div",Re,[(i(),a(S,null,I(T,s=>t("div",{key:s.id,class:"form-check form-check-inline mb-0"},[t("input",{class:"form-check-input",type:"checkbox",id:"evt_"+s.id,checked:x.value.includes(s.id),onChange:u=>K(s.id)},null,40,Te),t("label",{class:"form-check-label",for:"evt_"+s.id},[l(o,{t:s.label},null,8,["t"])],8,Ue)])),64))])]),E.value.length>0?(i(),a("div",Be,[t("label",Ve,[l(o,{t:"Webhooks"})]),(i(!0),a(S,null,I(E.value,s=>(i(),a("div",{key:s.WebHookID,class:"form-check"},[t("input",{class:"form-check-input",type:"checkbox",id:"wh_"+s.WebHookID,checked:k.value.includes(s.WebHookID),onChange:u=>F(s.WebHookID)},null,40,Fe),t("label",{class:"form-check-label",for:"wh_"+s.WebHookID},[g(d(s.PayloadURL)+" ",1),s.IsActive?b("",!0):(i(),a("span",ze,"disabled"))],8,Ke)]))),128))])):(i(),a("div",qe,[l(o,{t:"No webhooks configured. Add webhooks in Settings."})]))]),t("div",Ge,[w.value||k.value.length>0?(i(),a("button",{key:0,class:"btn btn-outline-danger btn-sm",onClick:V},[e[18]||(e[18]=t("i",{class:"bi bi-bell-slash me-1"},null,-1)),l(o,{t:"Clear All"})])):b("",!0),t("button",{class:"btn btn-secondary",onClick:e[3]||(e[3]=s=>y.value=!1)},[l(o,{t:"Cancel"})]),t("button",{class:"btn btn-primary",onClick:B},[e[19]||(e[19]=t("i",{class:"bi bi-check-lg me-1"},null,-1)),l(o,{t:"Save"})])])])])])):b("",!0)],64)}}},Ze=Z(Je,[["__scopeId","data-v-2e2de83e"]]);export{Ze as default};
